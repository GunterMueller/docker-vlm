#!/usr/bin/env bash
#
# -*- mode: shell; -*-
#
################################################################
#
# This script is meant to be a wrapper around running
# Symbolics VLM under Docker.
#
# Optional Arguments:
#
#   -i <image>     Use the specified image. If not set, the
#                  default name 'docker-vlm' will be used.
#
#   -c <container> Run the named container. If not set, the
#                  default name 'docker-vlm' will be used.
#
#   -s <dir>       Set LOCAL directory under which sys.sct
#                  can be found. e.g. "-s /var/lib/symbolics"
#                  If this argument is omitted, the default
#                  bundled sys.sct files will be used.
#
#   -g <dir>       Set the LOCAL directory under which the X86-64
#                  binary "genera" can be found. e.g.
#                  "-g /path/to/dir/". If this argument is omitted,
#                  the default bundled executable will be used
#                  instead.
#
################################################################

IMAGE="docker-vlm"
CONTAINER="docker-vlm"
SYSSCT=
GENERA=
DOPTS=
OS='unknown'

unamestr=`uname`

if [[ "$unamestr" == 'Linux' ]] ; then
    platform='linux'
elif [[ "$unamestr" == 'Darwin' ]] ; then
    platform='darwin'
else
    echo "Unknown platform '$unamestr'. Can't run." >&2
    exit 1
fi

while getopts ":i:s:g:c:h" opt; do
    case $opt in
        i)
            echo "Will use Docker image $OPTARG"
            IMAGE=$OPTARG
            ;;
        c)
            echo "Will use Docker container $OPTARG"
            CONTAINER=$OPTARG
            ;;
        s)
            echo "Will use directory $OPTARG to find sys.sct"
            DOPTS="$DOPTS -v $OPTARG:/var/lib/symbolics:rw"
            ;;
        g)
            echo "Will use directory $OPTARG to find genera binary"
            DOPTS="$DOPTS -v $OPTARG:/home/genera/bin:rw"
            GENERA=$OPTARG
            ;;
        h)
            echo "Usage: dvlm [-i <image>] [-c <container>] [-s <dir>] [-g <dir>]"
            echo ""
            echo "-i <image>     Use the specified image. If not set, the default name"
            echo "               'docker-vlm' will be used."
            echo ""
            echo "-c <container> Run the named container. If not set, the default name"
            echo "               'docker-vlm' will be used."
            echo ""
            echo "-s <dir>       Set LOCAL directory under which sys.sct can be found."
            echo "               e.g. '-s /var/lib/symbolics'. If this argument is"
            echo "               omitted, the default bundled sys.sct files will be used."
            echo ""
            echo "-g <dir>       Set the LOCAL directory under which the X86-64 binary"
            echo "               'genera' can be found. e.g. '-g /path/to/dir'. If this"
            echo "               argument is omitted, the default bundled executable will"
            echo "               be used instead."
            exit 1
            ;;
        \?)
            echo "Invalid option: -$OPTARG" >&2
            ;;
        :)
            echo "Option -$OPTARG requires an argument" >&2
            ;;
    esac
done

#### Verify that /tmp/.X11-unix exists.

if [[ $platform == 'linux' ]] ; then
    if [ ! -d /tmp/.X11-unix ] ; then
        echo "*** ERROR: Can't find X11 socket directory /tmp/.X11-unix" >&2
        exit 1
    fi
fi

#### Verify that a container for the image exists

if docker ps -a --format="{{.Image}}" | grep -q $IMAGE  ; then
    echo "Found existing container for docker image ${IMAGE}"

    if [ ! -z "$DOPTS" ] ; then
        echo "WARNING: Ignoring -g and -s options, container already exists." >&2
    fi
else
    echo "Creating docker container ${CONTAINER}"
    
    if [[ $platform == 'linux' ]] ; then
        echo "Linux detected. Running under X11."
        docker create -ti --privileged -P $DOPTS \
               -e "DISPLAY" \
               -v "/tmp/.X11-unix/:/tmp/.X11-unix/:rw" \
               --name $CONTAINER $IMAGE
    elif [[ $platform == 'darwin' ]] ; then
        echo "Darwin / OS X detected. Running under VNC."
        docker create -ti --privileged -P $DOPTS \
               -p 5901:5901 \
               --entrypoint /home/genera/run-vnc.sh \
               --name $CONTAINER $IMAGE
    fi
fi

### Start the container

docker start -ai $CONTAINER
